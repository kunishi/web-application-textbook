# HTTPクッキーと認証
ここまで述べたようにHTTPはステートレスなプロトコルであり、クライアント状態をサーバが保存することはない。しかし現実のアプリケーションでは、サービスへのログインなど、何らかのクライアント状態によってサーバの振る舞いを変えるニーズが存在する。

本章では、クライアント状態をWebアプリケーションで実現するための技術であるHTTPクッキーについて述べ、クライアント状態の典型例であるユーザ認証の実現方法をいくつか示す。

## HTTPクッキー

- 主なもの
    - セッション
    - クッキー
    - 通常のソフトで使われるもの(データベース、メモリ上の変数、ファイルなど)
- Webの原則(再掲)
    - ステートレスな通信
        - リクエストを処理するのに必要な情報はすべてクライアントから毎回送信
        - サーバはこれらの情報を記憶しない
- 実際のニーズ
    - ユーザごとに違う情報を提示したい
        - ログイン前とログイン後とで表示を変えたい
        - 認証
- 両者の両立？
    - 認証(BASIC認証)
        - リクエストヘッダに認証用IDとパスワードを埋め込んで送信
        - BASE64方式で符号化
        - 最初の1回だけユーザにIDとパスワードを入力してもらい、ブラウザの内部に保存、次回以降のリクエストではこれを使用
        - ブラウザをを終了するとID、パスワードも消える
        - 符号化方式が簡単すぎ(すぐに元に戻せる)→盗聴の危険
    - クッキー
        - 1994年にネットスケープ社が提案
        - ブラウザ内部からしか読み出せない、小さなストレージ
            - １項目ごと4Kバイト、1ドメインについて20項目まで
            - 有効期限：デフォルトはブラウザを閉じるまで、Set-Cookie: 送信時に変更可
        - 手順
            - サーバ→ブラウザ：レスポンスヘッダに Set-Cookie: という属性を付けて送信
            - ブラウザ：Set-Cookie: の値をURLにひもづけて保存
            - ブラウザ→サーバ：次に同じURLにアクセスした時に、ひもづけられたすべてのクッキーをリクエストヘッダの Cookie: 属性として送信
        - クッキーを用いたユーザ認証
            - 実現方法
                - セッション一つ一つに固有のID（セッションID）を振る
                - セッション開始時にセッションIDをクッキーとして送信
            - 認証の例
                - ブラウザ→サーバ：ID/パスワードを送信
                - サーバ：認証（DBチェック）
                - サーバ→ブラウザ：認証が成功したら、新たなセッションIDを発行してクッキーとして送信
                - ブラウザ→サーバ：以降、ログアウトするまでセッションIDを付与して送信
                - ブラウザ→サーバ：ログアウト時にクッキーの無効化