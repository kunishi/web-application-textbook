# セキュリティ

- 安全確保、機密保持
- バグに起因
- 通信が絡むとデータを守るべき箇所が増える
- ユーザとしてのセキュリティ（使っているパソコン + α）→開発者としてのセキュリティ（サーバ、クライアント、通信路）

## 通信における危険性

一般に、通信におけるセキュリティ上の危険には、次の3つが考えられる。

- 盗聴：通信路を流れるデータを第三者が盗み見る
- 改ざん：通信路を流れるデータを第三者が不正に書き換える
- なりすまし：第三者が正規の通信相手に成り代わり通信を行い、不正な行為を行う

インターネットにおける通信では、これらのセキュリティ上の危険に対し、**公開鍵基盤**（Public Key Infrastructure, PKI）という公開鍵暗号方式を基礎とする解決策が広く用いられている。特にWebでは、PKIを利用したセキュアな通信方式である**TLS**(Transport Layer Security)[^1]が広く用いられる。TLSはトランスポート層(TCP, UDP)とアプリケーション層の間に置かれるプロトコルであり、Web(HTTP)だけでなく、FTP, LDAP, TELNETなどのアプリケーション層プロトコルでも利用できる。

特に、TLS上で実現されるHTTP通信プロトコルを**HTTPS**と呼ぶ。HTTPSはデフォルトでは443番のポートを用いる。

[^1]: 以前は**SSL**(Secure Socket Layer)というアルゴリズムが使われていたが、セキュリティ上の不備がアルゴリズムに発見されたため、現在はその後継であるTLSを用いるのが普通である。ただし「PKIを用いたWebにおけるセキュアな通信」の総称として「SSL」という言葉を用いることも少なくない。

## 暗号化技術

TLSの説明をする前に、技術基盤となる暗号化について簡単に解説しておこう。

### エンコードと暗号化

データに対し、後で元に戻せるような変換を施すことを **エンコード** (符号化, encode)という。エンコードされたデータを元に戻すことを **デコード** (decode)という。ここまでに登場したMIMEエンコーディング、BASE64エンコーディング、URLエンコーディングなどはエンコードの例である。ただし、セキュリティの観点では、一般にエンコードされたデータは誰でもデコードすることができるため、セキュリティ上の危険への対策にはなっていない。

エンコードの特殊な場合として、通信の当事者間でのみ共有される秘密の情報を用いなければデコードできない、というものを考えることができる。このようなエンコードを **暗号化** (encrypt)、暗号化されたデータを復元することを **復号** (decrypt)という。また、暗号化および復号において用いられる、当事者間でのみ共有される秘密の情報を **鍵** (key)という。

### 共通鍵暗号方式

暗号化の方式で最も簡単なのは、暗号化と復号とで同じ鍵を用いる方式である。これを **共通鍵暗号方式** (symmetric key cryptography)という。共通鍵暗号方式では、通信の当事者間で同じ鍵（ **共通鍵** , symmetric key)を共有する。共通鍵暗号によるデータの暗号化・復号の概略は次のようになる。

1. あらかじめ生成された共通鍵$$K$$を、何らかの方法で送り手と受け手とで共有しておく。
2. 送り手は$$K$$を用いて送信したいデータ$$D$$を暗号化し（$$D' = {encrypt}(D, K)$$）、暗号化後のデータ$$D'$$を受け手に送信する。
3. 受け手は$$K$$を用いて$$D'$$を復号し（$$D = decrypt(D', K)$$）、元のデータ$$D$$を得る。

### 公開鍵暗号方式

PKIにおいて重要となるもう一つの暗号化方式が **公開鍵暗号方式** (public key cryptography)である。公開鍵暗号方式は、共通鍵暗号方式に比べ計算コストが高いが、後述するように、共通鍵暗号方式での問題点であった「鍵の共有」について解決策を与えるとともに、デジタルデータへの署名（デジタル署名）という別の用途にも解決策を与えている。

公開鍵暗号方式では **秘密鍵** (private key)と **公開鍵** (public key)という2本の鍵を用いる。これらは常に対として用いられ、かつ、次に示す重要な性質がある。

- 秘密鍵$$SK$$ で暗号化されたデータは公開鍵$$PK$$でしか復号できない。($$D' = encrypt(D, SK)$$ の時 $$D = decrypt(D', PK)$$)
- 公開鍵$$PK$$で暗号化されたデータは秘密鍵$$SK$$でしか復号できない。($$D' = encrypt(D, PK)$$ の時 $$D = decrypt(D', SK)$$)

後述するように、TLSにおいては、秘密鍵は鍵を生成した当事者が誰にも（もちろん他の当事者にも）知られないよう厳重に保管し、一方公開鍵は誰でも（通信の当事者以外の人でも）利用できるように公開する、という使い方をする。

### 暗号学的ハッシュ関数

暗号とは異なるが、PKIにおいて重要な役割を果たす**暗号学的ハッシュ関数** (cryptographic hash function)というものを紹介しておこう。これは、任意のデータを与えると固定長のビット列を出力する関数($$H = hash(D)$$)で、かつ次のような性質を持つ。

- 出力結果$$H$$から元のデータ$$D$$を求めることは極めて困難（事実上不可能）である。
- 同じ出力を得るような2つの異なる入力を求めることは極めて困難（事実上不可能）である。（$$hash(D_1) = hash(D_2), D_1 \neq D_2$$ となる$$D1, D2$$は事実上求められない） つまり、$$D_1 \neq D_2$$ と $$hash(D_1) \neq hash(D_2)$$ は事実上同値であると考えてよい。

$$H$$は、データ$$D$$のある種の要約であると考えることができる。この意味で、$$H$$を**ダイジェスト** (digest)と呼ぶ。

## TLS

では、盗聴・改ざん・なりすましへの対策の観点から、TLSの概要を説明することにしよう。なお、以下の説明では、理解を助けるために、各段階ではやや技術的に不正確な記述をあえてしている。

### 盗聴への対策：共通鍵暗号+公開鍵暗号

まず盗聴への対策である。これは、共通鍵暗号方式によってデータを暗号化すれば良い。

ただし、共通鍵暗号方式には、共通鍵の共有を安全に行わなければならないという大きな問題が残っている。TLSでは、ここで公開鍵暗号方式を利用している。大まかには次のようになる[^2]。

1. Webサーバ `server` 上であらかじめ公開鍵$$PK_{serv}$$と秘密鍵$$SK_{serv}$$を生成し、$$PK_{serv}$$を公開しておく。一方、$$SK_{serv}$$はサーバ外部からアクセスできないようにしておく。
2. Webクライアント`client`は共通鍵$$K$$を生成し、次に$$PK_{serv}$$をダウンロードし、$$PK_{serv}$$で$$K$$を暗号化する（$$D = encrypt(K, PK_{serv})$$）。暗号化した結果$$D$$を`server`に送信する。
3. `server` は$$D$$を受け取り、自身の秘密鍵$$SK_{serv}$$ で$$D$$を復号して$$K$$をとりだす。($$K = decrypt(D, SK_{serv})$$)

公開鍵暗号方式の性質により、$$D = encrypt(K, PK_{serv})$$の復号は$$SK_{serv}$$が必要であり、（Webサーバで$$SK_{serv}$$が厳格に保管されている限り）盗聴される心配はない。

[^2]: 厳密には、TLSで使用できる公開鍵暗号方式にはいくつか選択肢があること、TLSで使用される共通鍵は複数であることなどの理由で、共通鍵を直接送るのではなく、プリマスターシークレットというデータを共有したのち、クライアント・サーバで合意されたアルゴリズムに従いマスターシークレットというデータを（サーバとクライアント双方で）生成、さらに必要な数だけ共通鍵を（サーバとクライアント双方で）生成、という手順を取る。(出典: http://detail.chiebukuro.yahoo.co.jp/qa/question_detail/q10142993040)

### 改ざんへの対策：ダイジェスト+電子署名

改ざんへの対策にはダイジェストが用いられる。

1. 送信側で、送信したいデータ$$D$$からダイジェスト$$H=hash(D)$$を計算し、
